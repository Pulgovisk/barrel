<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--
Design by Free CSS Templates
http://www.freecsstemplates.org
Released for free under a Creative Commons Attribution 2.5 License

Name       : Brown Stone  
Description: A two-column, fixed-width design with dark color scheme.
Version    : 1.0
Released   : 20100928

-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="keywords" content="" />
<meta name="description" content="" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>The Kernel is dead! Long live the Kernel</title>
<link href="/theme/css/style.css" rel="stylesheet" type="text/css" media="screen" />
<link href="/" type="application/atom+xml" rel="alternate" title="barrel.rs ATOM Feed" />
<link href="/rss.xml" type="application/rss+xml" rel="alternate" title="barrel.rs RSS Feed" />
</head>
<body>
<div id="wrapper">
	<div id="page">
		<div id="page-bgtop">
			<div id="page-bgbtm">
    
                        	<div id="content">
					<div class="post">
						<h2 class="title"><a href="drafts/the-kernel-is-dead-long-live-the-kernel.html">The Kernel is dead! Long live the Kernel</a></h2>
						<p class="meta"><span class="date">Le 2018-02-08 </span><span class="posted">Par <a href="#">Sql People</a></span><span>&nbsp; | Cat√©gorie : <a href="/blog">Blog</a></span></p>
					<p class="meta">Tags : <span><a href="/devdiary">/dev/diary</a> / </span>
<span><a href="/linux">linux</a> / </span>
<span><a href="/arch-linux">arch linux</a> / </span>
<span><a href="/pacman">pacman</a> / </span>
</p>	
						<div style="clear: both;">&nbsp;</div>
						<div class="entry">
						 <p>So I run Arch Linux and mostly I love it (I'm weird, I know üòù). But there is one thing that's really been annoying me which happens after some <code>pacman -Syyu</code> runs: all of my old kernel modules become unavailable, forcing me to do a reboot. But recently I found some stuff online to prevent that from happening so let's document all of it here.</p>
<p>I have similar hooks, with a slight difference - keep <code>/usr/lib/modules/$(uname -r)</code> looking exactly the same as before the upgrade.</p>
<p>We need a hook that is run before a pacman transaction</p>
<div class="highlight"><pre><span></span><span class="c1"># /etc/pacman.d/hooks/linux-modules-pre.hook</span>

<span class="p">[</span><span class="nv">Trigger</span><span class="p">]</span>
<span class="nv">Operation</span> <span class="o">=</span> <span class="nv">Upgrade</span>
<span class="nv">Type</span> <span class="o">=</span> <span class="nv">Package</span>
<span class="nv">Target</span> <span class="o">=</span> <span class="s s-Atom">linux</span>

<span class="p">[</span><span class="nv">Action</span><span class="p">]</span>
<span class="nv">Description</span> <span class="o">=</span> <span class="nv">Save</span> <span class="nv">Linux</span> <span class="s s-Atom">kernel</span> <span class="s s-Atom">modules</span>
<span class="nv">When</span> <span class="o">=</span> <span class="nv">PreTransaction</span>
<span class="nv">Depends</span> <span class="o">=</span> <span class="s s-Atom">rsync</span>
<span class="nv">Exec</span> <span class="o">=</span> <span class="o">/</span><span class="s s-Atom">bin</span><span class="o">/</span><span class="s s-Atom">sh</span> <span class="o">-</span><span class="s s-Atom">c</span> <span class="s s-Atom">&#39;KVER=&quot;${KVER:-$(uname -r)}&quot;; if test -e &quot;/lib/modules/${KVER}&quot;; then rsync -AHXal --delete-after &quot;/lib/modules/${KVER}&quot; /lib/modules/backup/; fi&#39;</span>
</pre></div>


<p>And another hook that is run after a pacman transaction (duh üòú)</p>
<div class="highlight"><pre><span></span><span class="c1"># /etc/pacman.d/hooks/linux-modules-post.hook</span>

<span class="p">[</span><span class="nv">Trigger</span><span class="p">]</span>
<span class="nv">Operation</span> <span class="o">=</span> <span class="nv">Upgrade</span>
<span class="nv">Type</span> <span class="o">=</span> <span class="nv">Package</span>
<span class="nv">Target</span> <span class="o">=</span> <span class="s s-Atom">linux</span>

<span class="p">[</span><span class="nv">Action</span><span class="p">]</span>
<span class="nv">Description</span> <span class="o">=</span> <span class="nv">Restore</span> <span class="nv">Linux</span> <span class="s s-Atom">kernel</span> <span class="s s-Atom">modules</span>
<span class="nv">When</span> <span class="o">=</span> <span class="nv">PostTransaction</span>
<span class="nv">Depends</span> <span class="o">=</span> <span class="s s-Atom">coreutils</span>
<span class="nv">Depends</span> <span class="o">=</span> <span class="s s-Atom">rsync</span>
<span class="nv">Exec</span> <span class="o">=</span> <span class="o">/</span><span class="s s-Atom">bin</span><span class="o">/</span><span class="s s-Atom">sh</span> <span class="o">-</span><span class="s s-Atom">xc</span> <span class="s s-Atom">&#39;KVER=&quot;${KVER:-$(uname -r)}&quot;; if test -e &quot;/lib/modules/backup/${KVER}&quot;; then rsync -AHXal --ignore-existing &quot;/lib/modules/backup/${KVER}&quot; /lib/modules/; fi; rm -rf /lib/modules/backup&#39;</span>
</pre></div>


<p>But that's only half of the problem. When we eventually reboot we want to clean up the old modules. This means writing a systemd service which cleas up our old modules when we finally start the new kernel.</p>
<div class="highlight"><pre><span></span># /etc/systemd/system/linux-modules-cleanup.service

[Unit]
Description=Clean up modules from old kernels

[Service]
Type=oneshot
ExecStart=/bin/bash -exc &#39;for i in /usr/lib/modules/[0-9]*; do if [[ $${i##*/} = \&#39;%v\&#39; ]] || pacman -Qo &quot;$${i}&quot;; then continue; fi; rsync -AHXal &quot;$${i}&quot; /usr/lib/modules/.old/; rm -rf &quot;$${i}&quot;; done&#39;

[Install]
WantedBy=basic.target
</pre></div>


<p>You can specify how long you want to keep your old kernel modules in this config file as well</p>
<div class="highlight"><pre><span></span># /etc/tmpfiles.d/linux-modules-cleanup.conf

R! /usr/lib/modules/.old/* - - - 4w    
</pre></div>


<p>I use <code>rsync --ignore-existing</code> to merge the backup even if <code>/lib/modules/$(uname -r)</code> still exists, in case most of its contents have disappeared in the upgrade but the directory still exists due to a stray file untracked by pacman.</p>	
						</div>
					</div>
			      
					<div style="clear: both;">&nbsp;</div>
				</div>
				<!-- end #content -->
				<div id="sidebar">
					<div id="logo">
						<h1><a href="">barrel.rs</a></h1>
					</div>
					<div id="menu">
						<ul>
							<li ><a href="">Home</a></li>
							<li ><a href="/archives.html">Archives</a></li>
						</ul>
					</div>
					<ul>
						<li>
							<h2>Cat√©gories</h2>
							<ul>
								 <li class="active"><a href="/blog">Blog</a></li>
							</ul>
						</li>
						<li>
						        <h2>Tags</h2>
						        <ul>
                                                                <li><a href="/devdiary">/dev/diary</a></li>
                                                                <li><a href="/rust">rust</a></li>
                                                                <li><a href="/ccc">CCC</a></li>
                                                                <li><a href="/reflections">reflections</a></li>
                                                                <li><a href="/programming">programming</a></li>
                                                                <li><a href="/meta">meta</a></li>
                                                                <li><a href="/moonscript">moonscript</a></li>
                                                                <li><a href="/libgdx">libgdx</a></li>
                                                                <li><a href="/game-dev">game dev</a></li>
                                                                <li><a href="/java">java</a></li>
                                                                <li><a href="/c3">c3</a></li>
                                                                <li><a href="/gsoc2016">gsoc2016</a></li>
                                                                <li><a href="/hardware">hardware</a></li>
                                                                <li><a href="/data-recovery">data recovery</a></li>
                                                                <li><a href="/linux">linux</a></li>
						        </ul>
						</li>
						
						
					</ul>
				</div>
				<!-- end #sidebar -->
				<div style="clear: both;">&nbsp;</div>
			</div>
		</div>
	</div>
	<!-- end #page -->

<div id="footer">
	<p>Copyright (c) 2008 Sitename.com. All rights reserved. Design by <a href="http://www.freecsstemplates.org/">CSS Templates</a>.</p>
	<p>Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>, which takes great advantages of <a href="http://python.org">python</a>.
</p>
</div>
<!-- end #footer -->
</body>
</html>